<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/fonts/fonts.css">
  <link rel="stylesheet" href="/assets/main.css">
  <title>Админка</title>
</head>
<body>
  <div id="navbar-container"></div>
  <h1>Админ-панель</h1>

  <!-- Форма логина -->
  <form id="loginForm">
    <input type="text" placeholder="Логин" id="username" required />
    <input type="password" placeholder="Пароль" id="password" required />
    <button type="submit">Войти</button>
  </form>

  <!-- Приветствие + выход -->
  <div id="userInfo" style="display:none;">
    <p id="welcome"></p>
    <button id="logoutBtn">Выйти</button>
  </div>

  <!-- Форма добавления проекта -->
  <form id="projectForm" style="display: none;" enctype="multipart/form-data">
    <input type="text" name="title" placeholder="Название проекта" required />
    <input type="text" name="description" placeholder="Описание проекта" />

    <select name="category" required>
      <option value="">Выберите категорию</option>
      <option value="жилые">Жилые</option>
      <option value="общественные">Общественные</option>
      <option value="коттеджи">Коттеджи</option>
    </select>

    <input type="number" name="year" placeholder="Год" min="1900" max="2099" required />
    
    <label>Обложка проекта:</label>
    <input type="file" name="coverImage" accept="image/*" required />

    <label>Изображения галереи:</label>
    <input type="file" name="galleryImages" accept="image/*" multiple />

    <button type="submit">Добавить проект</button>
  </form>

  <h2>Список проектов</h2>
  <div id="projectsList" class="admin-projects-container"></div>

  <!-- Скрипт логина + проверки -->
  <script>
    async function checkSession() {
      const res = await fetch('/api/checkSession', { credentials: 'include' });
      const data = await res.json();

      if (data.sessionExists) {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('projectForm').style.display = 'block';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('welcome').textContent = `Здравствуйте, ${data.username || 'админ'}`;
      } else {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('projectForm').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
      }
    }

    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();

      if (res.ok && data.ok) {
        await checkSession();
      } else {
        alert('Ошибка входа');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
      });
      await checkSession();
    });

    checkSession(); // при загрузке
  </script>

  <!-- Подключаем admin.js -->
  <script src="admin.js"></script>
  <script>
    // Подгружаем navbar
    fetch('navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar-container').innerHTML = html;
      });
  </script>
</body>
</html>
